{% extends 'base.html' %}
{% load static %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/cart.css' %}" />
{% endblock %}

{% block content %}
<section class="cart">
<h1 class="carttitle">Your ReelzAir Cart</h1>

{% if items %}
  {% for item in items %}
    <div class="cart-item card">
      <img src="{% static 'images/shoppingcart/'|add:item.product.product|add:'.svg' %}" alt="{{ item.product.name }}">
      <h3>{{ item.product.name }}</h3>
      <p>Quantity: <span class="quantity">{{ item.quantity }}</span></p>
      <p class="item-total">Total: ${{ item.item_total }}</p>

      <button class="increase" data-id="{{ item.id }}">+</button>
      <button class="decrease" data-id="{{ item.id }}">âˆ’</button>
      <button class="delete-item" data-id="{{ item.id }}">Remove</button>
    </div>
  {% endfor %}

  <div id="price">
    <h3>Subtotal: ${{ total }}</h3>
  </div>

  <div class="buttons-container">
    <a href="{% url 'checkout' %}" class="cta-button">Proceed to Checkout</a>
    <a href="{% url 'home' %}" class="cta-button2">Continue Shopping</a>
  </div>
  
  {% else %}
  <p>Your cart is empty.</p>
{% endif %}
{% endblock %}
</section>

{% block extra_js %}
<script>
  document.querySelectorAll(".increase, .decrease").forEach((button) => {
    button.addEventListener("click", function () {
      const itemId = this.dataset.id;
      const action = this.classList.contains("increase") ? "increase" : "decrease";

      fetch(`/cart/item/${itemId}/update/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
          "Content-Type": "application/x-www-form-urlencoded",
        },
        body: new URLSearchParams({ action }),
      })
      .then((response) => response.json())
      .then((data) => {
        this.parentElement.querySelector(".quantity").textContent = data.quantity;
        this.parentElement.querySelector(".item-total").textContent = `$${data.item_total.toFixed(2)}`;
        updateSubtotal();
      });
    });
  });

  document.querySelectorAll(".delete-item").forEach((button) => {
    button.addEventListener("click", function () {
      const itemId = this.dataset.id;
      fetch(`/cart/item/${itemId}/delete/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
          "Content-Type": "application/x-www-form-urlencoded",
        },
      })
      .then((response) => response.json())
      .then((data) => {
        if (data.deleted) {
          this.closest(".cart-item").remove();
          updateSubtotal();
        }
      });
    });
  });

  function updateSubtotal() {
    let subtotal = 0;
    document.querySelectorAll(".item-total").forEach((el) => {
      subtotal += parseFloat(el.textContent.replace(/[^0-9.]/g, ""));
    });
    document.querySelector("#price p").textContent = `$${subtotal.toFixed(2)}`;
  }
</script>
{% endblock %}